<extend file='addons/store/template/admin.html'/>
<block name="content">
    <ul class="nav nav-tabs" role="tablist">
        <li><a href="{{url('app.lists',['type'=>$_GET['type']])}}">插件列表</a></li>
        <li class="active"><a href="{{url('app.add',['type'=>$_GET['type']])}}">添加插件</a></li>
    </ul>
    <br/>
    <form class="form-horizontal ng-cloak" ng-cloak ng-controller="ctrl">
        <input type="hidden" name="type" value="{{$_GET['type']}}">
        <div class="alert alert-info">
            每个帐号初始会有 100个 <b>大神币</b> ,当大神币为零时不允许发布应用。
            <br>你当前拥有 00 个大神币。
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                添加{{$app_title}}
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="col-sm-2 control-label"></label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <div class="input-group-btn">
                                <button ng-click="upFile()" class="btn btn-default" type="button">选择压缩包</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div n1g-show="field.title">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">名称</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" ng-model="field.title" disabled="disabled">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">标识</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" ng-model="field.name" disabled="disabled">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">版本号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" ng-model="field.version" disabled="disabled">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">模块描述</label>
                        <div class="col-sm-10">
                            <textarea id="container" style="height:300px;width:100%;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">发布{{$app_title}}</button>
    </form>
</block>
<script>
    require(['angular', 'underscore', 'util', 'jquery', 'hdcms'], function (angular, _, util, $, hdcms) {
        angular.module('app', []).controller('ctrl', ['$scope', function ($scope) {
            $scope.field={content:''};
            //上传软件包
            $scope.upFile = function () {
                options = {
                    extensions: 'zip',
                    data: {data: 'ext_app', status: 0}
                };
                util.file(function (files) {
                    if (files.length == 1) {
                        $.post('{{url("app.unpack")}}',{file:files[0]},function(json){
                            $scope.field=json;
                            $scope.$apply();
                        },'json');
                    }
                }, options)
            }
            //图文编辑器
            util.ueditor('container', {}, function (editor) {
                editor.addListener('contentChange', function () {
                    $scope.field.content = editor.getContent();
                });
                editor.addListener('ready', function () {
                    if (editor && editor.getContent() != $scope.field.content) {
                        editor.setContent($scope.field.content);
                    }
                    $scope.$watch('field', function (item) {
                        if (editor && editor.getContent() != item.content) {
                            editor.setContent(item.content ? item.content : '');
                        }
                    },true);
                });
                editor.addListener('clearRange', function () {
                    $scope.field.content = editor.getContent();
                    $scope.$apply();
                });
            });
            //提交表单
            $("form").submit(function () {
                return true;
            })
        }]);
        $(function () {
            angular.bootstrap($("form")[0], ['app']);
        });
    });

</script>
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="http://gosspublic.alicdn.com/aliyun-oss-sdk-4.4.4.min.js"></script>
</head>
<body>


<div class="form-group">
    <label>Select file</label>
    <input type="file" id="file" />
</div>
<div class="form-group">
    <label>Store as</label>
    <input type="text" class="form-control" id="object-key-file" value="object" />
</div>
<div class="form-group">
    <input type="button" class="btn btn-primary" id="file-button" value="Upload" />
</div>
<div class="form-group">
    <div class="progress">
        <div id="progress-bar"
             class="progress-bar"
             role="progressbar"
             aria-valuenow="0"
             aria-valuemin="0"
             aria-valuemax="100" style="min-width: 2em;">
            0%
        </div>
    </div>
</div>
</body>
</html>

<script>
    var appServer = 'http://dev.hdcms.com';
    var bucket = 'houdunren';
    var region = 'oss-cn-hangzho';
    var urllib = OSS.urllib;
    var OSS = OSS.Wrapper;
    var STS = OSS.STS;
    var applyTokenDo = function (func) {
        var url = appServer;
        return urllib.request(url, {
            method: 'GET'
        }).then(function (result) {
            var creds = JSON.parse(result.data);
            var client = new OSS({
                region: region,
                accessKeyId: 'VUFGPITAyRwwi296',
                accessKeySecret: 'DQDn3RSYzZ8OgZrUUfcRrnPYJgZ43r',
                stsToken: creds.SecurityToken,
                bucket: 'houdunren'
            });
            return func(client);
        });
    };
    var progress = function (p) {
        return function (done) {
            var bar = document.getElementById('progress-bar');
            bar.style.width = Math.floor(p * 100) + '%';
            bar.innerHTML = Math.floor(p * 100) + '%';
            done();
        }
    };
    var uploadFile = function (client) {
        var file = document.getElementById('file').files[0];
        var key = document.getElementById('object-key-file').value.trim() || 'object';
        console.log(file.name + ' => ' + key);
        return client.multipartUpload(key, file, {
            progress: progress
        }).then(function (res) {
            console.log('upload success: %j', res);
            return listFiles(client);
        });
    };
    window.onload = function () {
        document.getElementById('file-button').onclick = function () {
            applyTokenDo(uploadFile);
        }
    };
</script>
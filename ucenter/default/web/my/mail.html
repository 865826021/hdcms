<extend file='ucenter/__UCENTER_TEMPLATE__/web/master.html'/>
<block name="content">
    <div class="alert alert-info">
        如果修改邮箱，登录将使用新邮箱登录。原有邮箱将废弃，请慎重设置。<br/>
        发送的验证码可能会在垃圾箱中，请注意查看。
    </div>
    <div class="panel panel-default" id="app">
        <div class="panel-heading">
            <h4 class="panel-title">
                绑定邮箱
                <span class="label label-success" v-if="info.email_valid">邮箱已经绑定</span>
            </h4>
        </div>
        <div class="panel-body">
            <form action="" method="post" v-cloak class="form-horizontal" @submit.prevent="submit">
                <div class="form-group">
                    <label class="col-sm-2 control-label">邮箱</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" v-model="info.email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">验证</label>
                    <div class="col-sm-10">
                        <div class="input-group" v-if="times==60">
                            <input type="text" class="form-control" v-model="code" placeholder="请输入邮箱中的验证码">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" @click="sendMailValid">发送验证码</button>
                            </span>
                        </div>
                        <div class="input-group" v-if="times<60">
                            <input type="text" class="form-control" disabled="disabled">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button"
                                        disabled="disabled">@{{times}}秒后发送</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-10 col-sm-offset-2">
                        <button class="btn btn-primary">保存资料</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</block>
<script>
    require(['vue', 'axios', 'util'], function (Vue, axios, util) {
        var vm = new Vue({
            el: '#app',
            mounted: function () {
                var times = localStorage.getItem('mailTimes');
                this.times = times * 1 <= 0 ? 60 : times;
                if (this.times < 60) {
                    this.changeTimes();
                }
            },
            data: {
                times: 60,
                info: JSON.parse('{{json_encode(v("member.info"))}}'),
                code: ''
            },
            methods: {
                submit: function () {
                    axios.post('{{__URL__}}', {email: this.info.email, code: this.code}).then(function (response) {
                        if (response.data.valid == 1) {
                            util.message(response.data.message, 'refresh', 'success');
                        } else {
                            util.message(response.data.message, '', 'warning');
                        }
                    });
                },
                //发送验证码
                sendMailValid: function () {
                    //发送邮件
                    axios.post('{{url("my.sendMail")}}', {email: this.info.email}).then(function (response) {
                        util.message(response.data.message)
                    });
                    this.changeTimes();
                },
                changeTimes: function () {
                    var timeId = setInterval(function () {
                        --vm.times
                        if (vm.times == 0) {
                            vm.times = 60;
                            clearInterval(timeId);
                        }
                        localStorage.setItem('mailTimes', vm.times);
                    }, 1000);
                }
            }
        })
    })
</script>